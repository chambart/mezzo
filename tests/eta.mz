open list

(* This is a slightly simplified version of a problem that I have in cps.mz *)

val consumer [a, q : perm] (
  consumes x: a,
  (| consumes (x @ a * q)) -> ()
| consumes q
) : () =
  ()

val f [a] (consumes xs: list a) : () =

  let j (| consumes xs @ list a) : () =
    ()
  in
  
  match xs with
  | Cons { head } ->

      (* Eta-expansion. *)
      let k1   (| consumes (head @ a * xs @ Cons { head; tail: list a })) : () =
	j()
      in

      (* No eta-expansion. *)
      let k2 : (| consumes (head @ a * xs @ Cons { head; tail: list a })) -> () =
	j
      in

      (* This works. *)
      (* consumer [a, (xs @ Cons { head; tail: list a })] (head, k1); *)

      (* This does NOT work, but I would like it to work! *)
      consumer [a, (xs @ Cons { head; tail: list a })] (head, k2)

      (* Comment 1: surprisingly, if I replace a with int everywhere, the code is accepted. *)
      (* Comment 2: this behavior seems to indicate that the type annotation that I gave
	 for k2 is checked (and is correct), but is not used. *)

  end
